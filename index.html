<!doctype html>
<html lang="ar" dir="rtl" data-theme="midnight">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªØ¹Ù„Ù…ÙŠ Ù…Ø¹ Ø§Ù„Ø·Ù„Ø§Ø¦Ø¹!</title>

  <style>
    body{
  overflow-x: hidden;
}

    .logoFallback{width:100%;height:100%;display:grid;place-items:center;font-weight:900;letter-spacing:.5px;color:var(--text);opacity:.85;}

    .starsTitle{margin-top:14px;margin-bottom:8px;text-align:center;font-size:var(--fs-16);font-weight:900;color:var(--muted);letter-spacing:.2px;}
    .starsRow{display:flex;gap:var(--gap);align-items:center;justify-content:center;margin-top:6px;user-select:none;flex-wrap:wrap;}
    .starName{
      display:flex;gap:6px;align-items:center;
      padding: calc(7px * var(--scale)) calc(12px * var(--scale));
      border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      font-size:var(--fs-13);font-weight:800;color:var(--text);
    }
    html[data-theme="school"] .starName{background:rgba(30,58,95,.04);}
    .star{
      font-size:clamp(14px, 12px + .4vw, 18px);
      line-height:1;
      color:rgba(255,255,255,.75);
      text-shadow:0 0 10px rgba(102,217,255,.35);
      animation:twinkle 2.8s infinite ease-in-out;
    }
    html[data-theme="school"] .star{color:rgba(30,58,95,.75);text-shadow:0 0 10px rgba(182,155,99,.28);}
    @keyframes twinkle{0%,100%{transform:translateY(0) scale(1);opacity:.75;}50%{transform:translateY(-2px) scale(1.05);opacity:1;}}

    .starfield{
      position:relative;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:var(--radius);
      background: rgba(255,255,255,.02);
      padding:var(--pad);
    }

    :root{
      --bg:#0b1220;
      --bg1:radial-gradient(1200px 600px at 80% 0%, rgba(102,217,255,.15), transparent 60%),
            radial-gradient(900px 500px at 10% 20%, rgba(46,229,157,.12), transparent 55%),
            var(--bg);
      --card:rgba(18,27,47,.85);
      --muted:#9fb0d0;
      --text:#eef3ff;
      --line:rgba(255,255,255,.08);
      --btnBg:rgba(255,255,255,.08);
      --btnBorder:var(--line);
      --inputBg:rgba(255,255,255,.06);
      --inputBorder:var(--line);
      --inputText:var(--text);
      --placeholder:rgba(159,176,208,.75);
      --optBg:rgba(255,255,255,.04);
      --optBorder:var(--line);
      --selectOptionBg:#0f172a;
      --selectOptionText:#eef3ff;
      --ok:#2ee59d;
      --bad:#ff6b6b;
      --primary1:rgba(102,217,255,.35);
      --primary2:rgba(102,217,255,.18);
      --danger1:rgba(255,107,107,.32);
      --danger2:rgba(255,107,107,.12);
      --shadow:0 12px 30px rgba(0,0,0,.25);
      --blur:blur(6px);

      /* ===== Responsive Tokens ===== */
      --scale: clamp(.92, .84 + .35vw, 1.08);

      --fs-12: clamp(11px, 10px + .18vw, 13px);
      --fs-13: clamp(12px, 11px + .22vw, 14px);
      --fs-16: clamp(14px, 12px + .35vw, 18px);
      --fs-18: clamp(16px, 13px + .50vw, 20px);

      --radius: clamp(12px, 10px + .40vw, 18px);
      --pad: clamp(10px, 8px + .50vw, 16px);
      --gap: clamp(8px, 6px + .40vw, 12px);

      --logoSize: clamp(44px, 38px + 1.20vw, 64px);
      --iconBtn: clamp(36px, 32px + .80vw, 46px);

      --btnPadY: clamp(10px, 9px + .20vw, 13px);
      --btnPadX: clamp(12px, 10px + .40vw, 16px);
    }

    html[data-theme="school"]{
      --bg:#f4f6fb;
      --bg1:radial-gradient(1000px 600px at 70% 0%, rgba(30,58,95,.10), transparent 60%),
            radial-gradient(900px 540px at 10% 20%, rgba(182,155,99,.12), transparent 55%),
            var(--bg);
      --card:rgba(255,255,255,.90);
      --muted:rgba(30,58,95,.72);
      --text:#0f1f35;
      --line:rgba(15,31,53,.12);
      --btnBg:rgba(30,58,95,.06);
      --btnBorder:rgba(15,31,53,.14);
      --inputBg:rgba(30,58,95,.05);
      --inputBorder:rgba(15,31,53,.14);
      --inputText:#0f1f35;
      --placeholder:rgba(15,31,53,.45);
      --optBg:rgba(30,58,95,.04);
      --optBorder:rgba(15,31,53,.12);
      --selectOptionBg:#ffffff;
      --selectOptionText:#0f1f35;
      --ok:#16a34a;
      --bad:#dc2626;
      --primary1:rgba(30,58,95,.22);
      --primary2:rgba(182,155,99,.20);
      --danger1:rgba(220,38,38,.18);
      --danger2:rgba(220,38,38,.10);
      --shadow:0 14px 34px rgba(15,31,53,.12);
      --blur:blur(4px);
    }

    *{box-sizing:border-box}
    html{ overflow-x:hidden; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial;
      background: var(--bg);
      color:var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      font-size: clamp(13px, 1.6vw, 16px);
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      z-index:-1;
      background: var(--bg1);
      background-repeat:no-repeat;
      background-size:cover;
      background-position:center top;
    }

    .wrap{
      width: min(1100px, 100%);
      margin: 0 auto;
      padding: clamp(12px, 3vw, 28px);
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    #appHeader{
      width: 100%;
      margin: 0 0 14px 0;
      display:flex;
      gap:var(--gap);
      align-items:center;
      justify-content:space-between;
    }

#appHeader.homeOnly{ justify-content:flex-end; }
#headerActions{ flex-shrink:0; display:flex; }



    #mainCard{
      flex: 1;
      display: flex;
      min-height: 0;
      flex-direction: column;
    }
    #mainCard > div{ flex: 1; }
    #mainCard > *{ width: 100%; }

    #screenHome{
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      min-height: 100%;
    }

    #screenHome .starfield{
      flex: 1;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .homeCenter{
      text-align:center;
      padding: calc(16px * var(--scale)) calc(10px * var(--scale));
      width: 100%;
      max-width: 820px;
      margin: 0 auto;
    }

    .brand{display:flex;gap:var(--gap);align-items:center}

    .logoBox{
      width: var(--logoSize);
      height: var(--logoSize);
      border-radius: calc(var(--radius) - 4px);
      border:1px solid var(--line);
      background:linear-gradient(135deg, rgba(182,155,99,.22), rgba(30,58,95,.12));
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:visible;
      padding: clamp(4px, 3px + .30vw, 7px);
    }
    .logoBox img{max-width:100%;max-height:100%;width:auto;height:auto;object-fit:contain;display:block;}

    h1{margin:0;font-size:var(--fs-18)}
    .sub{margin:0;color:var(--muted);font-size:var(--fs-13)}

    .grid{ flex: 1; display: flex; min-height: 0; }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:var(--pad);
      box-shadow:var(--shadow);
      backdrop-filter:var(--blur);
      min-height: 0;
    }

    .row{display:flex;gap:var(--gap);flex-wrap:wrap}
    label{display:block;font-size:var(--fs-12);color:var(--muted);margin:10px 0 6px}

    input,select,textarea{
      width:100%;
      padding: clamp(10px, 9px + .30vw, 13px) clamp(10px, 9px + .30vw, 14px);
      border-radius: calc(var(--radius) - 6px);
      background:var(--inputBg);
      border:1px solid var(--inputBorder);
      color:var(--inputText);
      outline:none;
      font-size: var(--fs-13);
    }
    input::placeholder{color:var(--placeholder)}
    select option{background:var(--selectOptionBg);color:var(--selectOptionText);}

    .btns{display:flex;gap:var(--gap);flex-wrap:wrap;margin-top:12px}
    button{
      border:0;
      border-radius: calc(var(--radius) - 6px);
      padding: var(--btnPadY) var(--btnPadX);
      cursor:pointer;
      font-weight:700;
      background:var(--btnBg);
      color:var(--text);
      border:1px solid var(--btnBorder);
      font-size: var(--fs-13);
    }
    button.primary{background:linear-gradient(135deg, var(--primary1), var(--primary2));}

    /* CTA button: make text scale a bit more with size */
    #goRegisterBtn{font-size: clamp(14px, 2.2vw, 18px);}
    button.danger{background:linear-gradient(135deg, var(--danger1), var(--danger2));}
    button.ghost{background:transparent}
    button:disabled{opacity:.5;cursor:not-allowed}

    .pill{
      padding: calc(6px * var(--scale)) calc(10px * var(--scale));
      border-radius:999px;
      font-size:var(--fs-12);
      border:1px solid var(--line);
      color:var(--muted);
      background:rgba(255,255,255,.04);
    }
    html[data-theme="school"] .pill{background:rgba(30,58,95,.04);}

    .topline{display:flex;gap:var(--gap);align-items:center;justify-content:space-between;flex-wrap:wrap}
    .qtitle{margin:8px 0 0;font-size:var(--fs-16)}
    .meta{display:flex;gap:var(--gap);flex-wrap:wrap;margin-top:8px}
    .answers{margin-top:12px;display:grid;gap:var(--gap)}

    .opt{
      display:flex;gap:var(--gap);
      align-items:flex-start;
      padding: calc(10px * var(--scale)) calc(12px * var(--scale));
      border-radius: calc(var(--radius) - 2px);
      border:1px solid var(--optBorder);
      background:var(--optBg);
      cursor:pointer;
      transition:transform .05s ease;
      font-size: var(--fs-13);
    }
    .opt:hover{transform:translateY(-1px)}
    .opt input{
      width: clamp(16px, 14px + .35vw, 20px);
      height: clamp(16px, 14px + .35vw, 20px);
      margin-top:2px
    }

    .hint{color:var(--muted);font-size:var(--fs-13);margin-top:8px;line-height:1.5}

    .bar{height:10px;border-radius:999px;overflow:hidden;background:rgba(255,255,255,.06);border:1px solid var(--line);margin-top:10px;}
    html[data-theme="school"] .bar{background:rgba(30,58,95,.06);}
    .bar>div{height:100%;width:0%;}
    .ok{color:var(--ok)}
    .bad{color:var(--bad)}

    table{width:100%;border-collapse:collapse;font-size:var(--fs-13)}
    th,td{padding: calc(10px * var(--scale)) calc(8px * var(--scale));border-bottom:1px solid var(--line);text-align:right;vertical-align:top}
    th{color:var(--muted);font-weight:700}
    .small{font-size:var(--fs-12);color:var(--muted)}

    .badge{
      font-size:var(--fs-12);
      padding: calc(4px * var(--scale)) calc(8px * var(--scale));
      border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.04)
    }
    html[data-theme="school"] .badge{background:rgba(30,58,95,.04);}

    .twocol{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
    @media (max-width: 860px){.twocol{grid-template-columns:1fr}}

    .themeToggle{
      width: var(--iconBtn);
      height: var(--iconBtn);
      border-radius: calc(var(--radius) - 6px);
      display:grid;
      place-items:center;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
      font-size: clamp(16px, 14px + .35vw, 20px);
    }
    html[data-theme="school"] .themeToggle{background:rgba(30,58,95,.04);}

    .homeBanner{
      margin-top:10px;border:1px solid var(--line);
      border-radius:var(--radius);
      overflow:hidden;background:rgba(255,255,255,.03);
      display:flex;justify-content:center;
    }
    .homeBanner img{
      width: 100%; max-width: 720px;
      max-height: clamp(160px, 22vh, 280px);
      height:auto;
      object-fit:contain;
      display:block;
    }

    .homeTitle{margin:10px 0 0;font-size:var(--fs-18);font-weight:900;}
    .homeSub{margin:8px 0 0;font-size:var(--fs-13);color:var(--muted);line-height:1.6;}

    .adminToggle{
      display:flex;
      align-items:center;
      gap:var(--gap);
      width:100%;
      margin:0;
      justify-content:flex-start;
    }
    .adminToggle span{flex:1;text-align:right;}
    .adminToggle input[type="checkbox"]{
      margin-inline-start:auto;
      width: clamp(16px, 14px + .35vw, 20px);
      height: clamp(16px, 14px + .35vw, 20px);
      accent-color:var(--ok);
      cursor:pointer;
    }

    /* Question Bank UI */
    .qbControls{display:flex;gap:var(--gap);flex-wrap:wrap;margin-top:10px}
    .qbControls > div{flex:1 1 220px}
    .qbItem{border:1px solid var(--line);background:rgba(255,255,255,.03);border-radius: calc(var(--radius) - 2px);padding: var(--pad)}
    html[data-theme="school"] .qbItem{background:rgba(30,58,95,.04);}
    .qbQ{color:var(--bad);font-weight:900;margin:0 0 8px;font-size:var(--fs-16);line-height:1.5;}
    .qbOpt{display:flex;gap:var(--gap);align-items:flex-start;padding: calc(8px * var(--scale)) calc(10px * var(--scale));border-radius: calc(var(--radius) - 6px);border:1px solid var(--line);margin-top:6px;background:rgba(255,255,255,.02)}
    .qbOpt .idx{min-width:22px;font-weight:900;color:var(--muted)}
    .qbOpt.correct{border-color:rgba(46,229,157,.35);background:rgba(46,229,157,.10)}
    html[data-theme="school"] .qbOpt.correct{border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.10)}
    .qbOpt.correct .txt{color:var(--ok);font-weight:900}
  
    /* Setup screen CTA emphasis */
    #screenSetup .btns{
      justify-content:center;
    }
    #screenSetup .btns .primary{
      font-size: clamp(16px, 2.8vw, 20px);
      padding: 14px 22px;
    }
    #screenSetup .btns button:not(.primary){
      font-size: clamp(13px, 1.6vw, 15px);
    }


    /* Secondary button refinement in setup screen */
    #screenSetup .btns .ghost{
      border:1px solid var(--line);
      background:transparent;
      color:var(--muted);
    }
    #screenSetup .btns{
      gap:16px;
      margin-top:18px;
    }


    /* Setup screen: secondary action as outline/ghost */
    #screenSetup #viewBoardBtn{
      background: transparent;
      border: 1px solid var(--line);
      color: var(--text);
    }
    #screenSetup #viewBoardBtn:hover{
      background: rgba(255,255,255,.05);
    }


    /* Home screen: remove border/shadow from logo card */
    #screenHome .card:first-child{
      border: none !important;
      box-shadow: none !important;
      background: transparent !important;
    }


    /* Home screen: remove all card borders/shadows completely */
    #screenHome .card{
      border: none !important;
      box-shadow: none !important;
      background: transparent !important;
    }


    /* HARD RESET: Home screen containers without borders or outlines */
    #screenHome .card,
    #screenHome .wrap,
    #screenHome .panel,
    #screenHome .container,
    #screenHome .content{
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
      background: transparent !important;
    }

    /* If card uses pseudo-elements for border */
    #screenHome .card::before,
    #screenHome .card::after{
      display:none !important;
      content:none !important;
    }


    /* Home screen: remove banner frame (border/background) */
    #screenHome .homeBanner{
      border: none !important;
      box-shadow: none !important;
      background: transparent !important;
    }


    /* Smart Challenge highlight */
    .glowDot{
      width:10px; height:10px; border-radius:50%;
      background: rgba(255,71,87,.95);
      box-shadow: 0 0 10px rgba(255,71,87,.65), 0 0 18px rgba(255,71,87,.35);
      animation: pulseGlow 1.2s ease-in-out infinite;
      display:inline-block;
    }
    @keyframes pulseGlow{
      0%,100%{ transform: scale(1); opacity:.85; }
      50%{ transform: scale(1.35); opacity:1; }
    }
    .dangerText{ color: var(--bad); font-weight:800; }


    /* Smart timer showcase */
    .timerRing{ position:relative; width:96px; height:96px; }
    .timerRing svg{ display:block; }
    .timerRingBg{ fill:none; stroke: rgba(255,255,255,.14); stroke-width:10; }
    .timerRingFg{
      fill:none; stroke: rgba(255,71,87,.95); stroke-width:10;
      stroke-linecap:round;
      transform: rotate(-90deg);
      transform-origin: 60px 60px;
      stroke-dasharray: 327; /* 2Ï€r where r=52 => ~326.7 */
      stroke-dashoffset: 0;
      filter: drop-shadow(0 0 10px rgba(255,71,87,.35));
    }
    .timerNum{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-size:34px; font-weight:900;
      letter-spacing:.5px;
    }
    .timerBigNum{
      font-size:44px;
      font-weight:950;
      line-height:1;
      margin-bottom:10px;
      text-align:center;
    }
    .timerBarWrap{
      height:16px;
      border-radius:999px;
      background: rgba(255,255,255,.14);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
    }
    .timerBarFill{
      height:100%;
      width:100%;
      border-radius:999px;
      background: rgba(255,71,87,.95);
      box-shadow: 0 0 14px rgba(255,71,87,.25);
      transition: width .2s linear;
    }
    .timerUrgent .timerNum, .timerUrgent .timerBigNum{
      animation: pulseGlow .8s ease-in-out infinite;
    }


    /* Setup notes emphasis for Smart Challenge */
    .notesDanger{
      border-color: rgba(255,71,87,.45) !important;
      background: rgba(255,71,87,.10) !important;
      box-shadow: 0 18px 40px rgba(0,0,0,.18);
    }
    html[data-theme="school"] .notesDanger{
      border-color: rgba(220,38,38,.30) !important;
      background: rgba(220,38,38,.08) !important;
      box-shadow: 0 16px 34px rgba(15,31,53,.10);
    }
    .notesDanger #setupNotesText{ color: var(--bad); font-weight:900; font-size: var(--fs-13); }
    .notesDanger .notesTitle{ color: var(--bad); font-weight:950; }

    /* Smart challenge timer (bar) inline under answers */
    #smartTimerInline{
      display:none;
      margin-top: 14px;
      margin-bottom: 6px;
      padding: 10px 0 0 0;
    }
    #smartTimerInline .timerBigNum{
      margin: 0 0 10px 0;
      font-size: clamp(46px, 5vw, 64px);
      font-weight: 950;
      text-align:center;
      letter-spacing:.5px;
      color: rgba(255,71,87,.95);
      text-shadow: 0 0 16px rgba(255,71,87,.25);
    }
    #smartTimerInline .timerBarWrap{
      height: 18px;
      max-width: 760px;
      margin: 0 auto;
    }


    /* Confirm modal (non-blocking) */
    .confirmOverlay{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:9999;}
    .confirmOverlay.show{display:flex;}
    .confirmBox{width:min(520px,92vw);background:rgba(20,27,38,.98);border:1px solid rgba(255,255,255,.14);border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.55);padding:16px;}
    .confirmTitle{font-weight:950;font-size:var(--fs-18);margin:0 0 8px 0;color:var(--text);}
    .confirmMsg{margin:0 0 14px 0;color:var(--text);opacity:.92;line-height:1.8;font-size:var(--fs-14);}
    .confirmActions{display:flex;gap:10px;justify-content:flex-start;}
    .confirmActions .danger{background:rgba(255,74,98,.16);border:1px solid rgba(255,74,98,.45);color:#ff4a62;}

    html[data-theme="school"] .confirmBox{background:rgba(255,255,255,.98);border:1px solid rgba(15,31,53,.12);box-shadow:0 18px 60px rgba(15,31,53,.18);}
    html[data-theme="school"] .confirmTitle{color:var(--text);}
    html[data-theme="school"] .confirmMsg{color:var(--text);opacity:.9;}

</style>
</head>

<body>
  <div class="wrap">
    <header id="appHeader">
      <div class="brand" id="headerBrand">
        <div class="logoBox" title="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©">
          <img id="siteLogo" alt="Logo" />
        </div>
        <div>
          <h1>ØªØ¹Ù„Ù…ÙŠ Ù…Ø¹ Ø§Ù„Ø·Ù„Ø§Ø¦Ø¹!</h1>
          <p class="sub">Ø£Ø³Ø¦Ù„Ø© ÙˆØ£Ø¬ÙˆØ¨Ø©</p>
        </div>
      </div>

      <div class="row" id="headerActions" style="align-items:center;">
        <span class="pill" id="statusPill" style="display:none;"></span>
        <div class="themeToggle" id="homeHeaderBtn" title="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" aria-label="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">ğŸ </div>
        <div class="themeToggle" id="adminHeaderBtn" title="Admin" aria-label="Admin">âš™ï¸</div>

        <div class="themeToggle" id="themeBtn" title="ØªØ¨Ø¯ÙŠÙ„ Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©" aria-label="ØªØ¨Ø¯ÙŠÙ„ Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©">ğŸŒ“</div>
      </div>
    </header>

    <div class="grid">
      <div class="card" id="mainCard">

        <!-- Home -->
        <div id="screenHome">
          <div class="starfield" aria-label="Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©">
            <div class="homeCenter">
              <div class="homeBanner" aria-label="Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©">
                <img id="mainBannerHome" alt="Tala'e Al-Ghad Schools" />
              </div>

              <div class="homeTitle">ØªØ¹Ù„Ù…ÙŠ Ù…Ø¹ Ø§Ù„Ø·Ù„Ø§Ø¦Ø¹!</div>

              <div class="btns" style="justify-content:center; margin-top:14px;">
                <button class="primary" id="goRegisterBtn">Ø§Ø¨Ø¯Ø¦ÙŠ Ø§Ù„Ø¢Ù†</button>
              </div>

              <div class="starsTitle" id="starsHomeTitle">Ù†Ø¬Ù…Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>
              <div class="starsRow" id="starsHome" aria-label="Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª"></div>
            </div>
          </div>
        </div>

        <!-- Setup -->
        <div id="screenSetup" style="display:none;">
          <div class="topline">
            <div><h2 style="margin:0; font-size:var(--fs-16);">ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚Ø©</h2></div>
          </div>

          <div class="row" style="gap:12px; margin-top:10px;">
            <div style="flex:1 1 240px;">
              <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©</label>
              <input id="studentName" placeholder="Ø§Ø¯Ø®Ù„ÙŠ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ" />
            </div>
            <div style="flex:1 1 180px;">
              <label>Ø§Ù„ØµÙ</label>
              <select id="studentGrade">
                <option value="" selected disabled>â€” Ø§Ø¯Ø®Ù„ÙŠ ØµÙÙƒ â€”</option>
                <option value="Ø£ÙˆÙ„ Ù…ØªÙˆØ³Ø·">Ø£ÙˆÙ„ Ù…ØªÙˆØ³Ø·</option>
                <option value="Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·">Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·</option>
                <option value="Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·">Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·</option>
              </select>
            </div>
          </div>
          <div class="row" style="gap:12px; margin-top:8px;">
            <div style="flex:1 1 240px;">
              <label style="display:flex; align-items:center; gap:8px;">
                <span class="glowDot" aria-hidden="true"></span>
                ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡
              </label>
              <button class="primary" id="smartChallengeBtn" style="width:100%;">Ø§Ù†Ù‚Ø± Ù‡Ù†Ø§ Ù„ØªÙØ¹ÙŠÙ„ ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡</button>
</div>
          </div>



          <div class="row" style="gap:12px;">
            <div style="flex:1 1 240px;">
              <label>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø©</label>
              <select id="subjectPick"><option value="">â€” Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ø§Ø¯Ø© â€”</option></select>
            </div>
            <div style="flex:1 1 240px;">
              <label>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©</label>
              <select id="difficultyPick">
                <option value="" selected disabled>â€” Ø§Ø¯Ø®Ù„ÙŠ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø© â€”</option>
                <option value="easy">Ø³Ù‡Ù„ </option>
                <option value="medium">Ù…ØªÙˆØ³Ø· </option>
                <option value="hard">ØµØ¹Ø¨ </option>
              </select>
            </div>
          </div>

          <div class="card" style="padding:14px; margin-top:12px;" id="setupNotesCard">
            <div class="row" style="justify-content:space-between; align-items:center; gap:12px;">
              <div class="notesTitle" style="font-weight:800;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</div>
              <div class="small" id="setupNotesModeTag"></div>
            </div>
            <div class="small" id="setupNotesText" style="margin-top:8px; line-height:1.8;"></div>
          </div>



          <div class="btns" style="justify-content:center;">
            <button class="primary" id="startBtn">Ø§Ø¨Ø¯Ø¦ÙŠ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</button>
            <button id="viewBoardBtn">Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
          </div>
        </div>

        <!-- Quiz -->
        <div id="screenQuiz" style="display:none;">
          <div class="topline">
            <div class="meta">
              <span class="badge" id="whoBadge"></span>
              <span class="badge" id="subjectBadge"></span>
              <span class="badge" id="qCountBadge"></span>
              <span class="badge" id="diffBadge"></span>
              <span class="badge" id="timerBadge" style="display:none;"></span>
            </div>
            <div class="meta">
              <button class="danger" id="resetQuizBtn" title="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
            </div>
          </div>

          <div class="bar" aria-label="Ø§Ù„ØªÙ‚Ø¯Ù…">
            <div id="progressFill" style="background:linear-gradient(90deg, rgba(102,217,255,.9), rgba(46,229,157,.9));"></div>
          </div>

          <h3 class="qtitle" id="qText"></h3>
          <div class="small" id="qType"></div>
          <div class="answers" id="answersBox"></div>

          <!-- Smart Challenge Timer (bar only) -->
          <div id="smartTimerInline" aria-label="Ù…Ø¤Ù‚Øª Ø§Ù„ØªØ­Ø¯ÙŠ">
            <div class="timerBigNum" id="smartTimerNum2">15</div>
            <div class="timerBarWrap" aria-label="Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø¤Ù‚Øª">
              <div class="timerBarFill" id="smartTimerFill"></div>
            </div>
          </div>


          <div class="btns" style="justify-content:center;">
            <button id="prevBtn">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
            <button class="primary" id="nextBtn">Ø§Ù„ØªØ§Ù„ÙŠ</button>
            <button class="primary" id="finishBtn" style="display:none;">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
          </div>

          <div class="hint" id="liveHint"></div>
        </div>

        <!-- Result -->
        <div id="screenResult" style="display:none;">
          <div class="topline">
            <div>
              <h2 style="margin:0; font-size:var(--fs-18);" id="resultTitle"></h2>
              <div class="small" id="resultMeta"></div>
            </div>
            <div class="meta">
              <button id="againBtn">Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
              <button id="boardBtn2">Ù„ÙˆØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
            </div>
          </div>

          <div style="margin-top:12px; display:grid; gap:var(--gap);">
            <div class="card" style="padding:var(--pad);">
              <div class="topline">
                <div>
                  <div class="small">Ø§Ù„Ù†Ù‚Ø§Ø·</div>
                  <div style="font-size:clamp(22px, 18px + 1.2vw, 32px); font-weight:800;" id="scoreBig"></div>
                </div>
                <div id="scoreBadge" class="pill"></div>
              </div>
              <div class="hint" id="reviewNote"></div>
            </div>

            <div class="card" style="padding:var(--pad);">
              <div class="topline"><h3 style="margin:0; font-size:var(--fs-16);">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ø±ÙŠØ¹Ø©</h3></div>
              <div id="reviewList" style="margin-top:10px; display:grid; gap:var(--gap);"></div>
            </div>
          </div>
        </div>

        <!-- Board -->
        <div id="screenBoard" style="display:none;">
          <div class="topline">
            <div>
              <h2 style="margin:0; font-size:var(--fs-16);">Ù„ÙˆØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h2>
                          </div>
            <div class="meta"><button id="backFromBoardBtn">Ø±Ø¬ÙˆØ¹</button></div>
          </div>

          <div style="margin-top:12px; overflow:auto;">
            <table>
              <thead>
                <tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr>
              </thead>
              <tbody id="boardBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Admin -->
        <div id="screenAdmin" style="display:none;">
          <div class="topline">
            <div>
              <h2 style="margin:0; font-size:var(--fs-16);">Ù„ÙˆØ­Ø© Admin</h2>
              <div class="small" style="margin-top:6px; color:var(--muted);"></div>
            </div>

            <div class="meta">
              <button id="backFromAdminBtn">Ø±Ø¬ÙˆØ¹</button>
              <button class="danger" id="logoutBtn" style="display:none;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
            </div>
          </div>

          <div id="adminLoginBox" style="margin-top:12px;">
            <div class="twocol">
              <div>
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                <input id="adminUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />
              </div>
              <div>
                <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input id="adminPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
              </div>
            </div>
            <div class="btns" style="justify-content:center;"><button class="primary" id="adminLoginBtn" type="button">Ø¯Ø®ÙˆÙ„</button></div>
          </div>

          <div id="adminPanelBox" style="display:none; margin-top:12px;">

            <div class="card" style="padding:var(--pad); margin-top:12px;">
              <label class="adminToggle">
                <h3 style="margin:0; font-size:var(--fs-16);">Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</h3>
                <input type="checkbox" id="autoNextToggle">
              </label>
            </div>

            <div class="card" style="padding:var(--pad); margin-top:12px;">
              <details id="qbDetails">
                <summary style="cursor:pointer; font-weight:900;">
                  Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                  <span class="badge" id="qbCountBadge" style="margin-inline-start:10px;"></span>
                </summary>

                <div style="margin-top:10px;">
                  <div class="qbControls">
                    <div>
                      <label>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                      <select id="qbSubjectPick"></select>
                    </div>
                    <div>
                      <label>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</label>
                      <select id="qbDiffPick">
                        <option value="">â€” Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ø³ØªÙˆÙ‰ â€”</option>
                        <option value="easy">Ø³Ù‡Ù„</option>
                        <option value="medium">Ù…ØªÙˆØ³Ø·</option>
                        <option value="hard">ØµØ¹Ø¨</option>
                      </select>
                    </div>
                  
                    <div style="display:flex; align-items:flex-end;">
                      <button class="ghost" id="qbResetBtn" style="width:100%;">Ù…Ø³Ø­ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</button>
                    </div>
</div>

                  <div class="small" style="margin-top:10px; display:flex; align-items:center; justify-content:flex-start; gap:10px; flex-wrap:wrap;">
                      <span class="badge" id="qbLevelCountBadge"></span>
                    </div>

                    <div class="small" style="margin-top:10px; line-height:1.6;">
                    Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø§Ù„Ø£Ø­Ù…Ø±ØŒ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¨Ø§Ù„Ø£Ø®Ø¶Ø±.
                  </div>

                  <div id="qbList" style="margin-top:12px; display:grid; gap:var(--gap);"></div>
                </div>
              </details>
            </div>

            <div class="card" style="padding:var(--pad); margin-top:12px;">
              <details id="starsDetails">
                <summary style="cursor:pointer; font-weight:900;">
                  Ø¥Ø¯Ø§Ø±Ø© Ù†Ø¬Ù…Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
                  <span class="badge" id="starsCountBadge" style="margin-inline-start:10px;"></span>
                </summary>

                <div style="margin-top:10px;">
                  <div class="small" style="margin-top:8px; color:var(--muted); line-height:1.6;">Ø§ÙƒØªØ¨ ÙƒÙ„ Ø§Ø³Ù… ÙÙŠ Ø³Ø·Ø± Ù…Ø³ØªÙ‚Ù„. Ø³ÙŠØªÙ… Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©.</div>
                  <label style="margin-top:10px;">Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (ÙƒÙ„ Ø³Ø·Ø± = Ø§Ø³Ù…)</label>
                  <textarea id="starsTextarea" rows="6" style="resize:vertical;"></textarea>
                  <div class="btns" style="margin-top:10px;">
                    <button class="primary" id="saveStarsBtn">Ø­ÙØ¸</button>
                    <button id="resetStarsBtn">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
                  </div>
                  <div class="small" id="starsSaveNote" style="margin-top:10px;"></div>
                </div>
              </details>
            </div>

            <div class="card" style="padding:var(--pad); margin-top:12px;">
              <details id="resultsDetails">
                <summary style="cursor:pointer; font-weight:900;">
                  Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²)
                  <span class="badge" id="adminManageCount" style="margin-inline-start:10px;"></span>
                </summary>

                <div style="margin-top:10px;">
                  <div class="btns" style="margin-top:10px;">
                    <button class="danger" id="clearLocalBtn">Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²</button>
                  </div>

                  <div style="margin-top:12px; overflow:auto;">
                    <table>
                      <thead>
                        <tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>
                      </thead>
                      <tbody id="adminManageBody"></tbody>
                    </table>
                  </div>

                  <div class="small" style="margin-top:10px;">
                    Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø­Ø°Ù Ù‡Ù†Ø§ Ù…Ø­Ù„ÙŠ (LocalStorage). Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø±ÙÙØ¹Øª Ù…Ø³Ø¨Ù‚Ù‹Ø§ Ø¥Ù„Ù‰ Google SheetØŒ ØªØ¨Ù‚Ù‰ Ù‡Ù†Ø§Ùƒ Ù…Ø§ Ù„Ù… ØªÙØ­Ø°Ù Ù…Ù† Ø§Ù„Ø´ÙŠØª.
                  </div>
                </div>
              </details>
            </div>

            <div class="card" style="padding:var(--pad); margin-top:12px;">
              <details id="cloudDetails">
                <summary style="cursor:pointer; font-weight:900;">
                  Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ
                </summary>

                <div style="margin-top:10px;">
                  <div class="small" style="margin-top:10px; color:var(--muted); line-height:1.6;">
                    Web App:
                    <div style="margin-top:6px; word-break:break-all; border:1px solid var(--line); background:rgba(255,255,255,.04); padding:10px 12px; border-radius:calc(var(--radius) - 6px);">
                      <span id="gsUrlView"></span>
                    </div>
                  </div>
                  <div class="btns" style="margin-top:12px;">
                    <button class="primary" id="pushUnsyncedBtn">Ø±ÙØ¹ ØºÙŠØ± Ø§Ù„Ù…Ø±ÙÙˆØ¹</button>
                    <button id="pushAllBtn">Ø±ÙØ¹ Ø§Ù„ÙƒÙ„</button>
                  </div>
                  <div class="small" id="syncNote" style="margin-top:10px;"></div>
                </div>
              </details>
            </div>

            <div class="card" style="padding:var(--pad); margin-top:12px;">
              <details id="ioDetails">
                <summary style="cursor:pointer; font-weight:900;">
                  Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
                  <div class="small" style="margin-top:6px;">ØªØµØ¯ÙŠØ± ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (CSV / JSON) Ù„Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø£Ùˆ Ù†Ù‚Ù„Ù‡Ø§ ÙŠØ¯ÙˆÙŠÙ‹Ø§.</div>
                  <span class="badge" id="adminCount" style="margin-inline-start:10px;"></span>
                </summary>

                <div style="margin-top:10px;">
                  <div class="btns" style="margin-top:10px;">
                    <button class="primary" id="exportCsvBtn">ØªØµØ¯ÙŠØ± CSV</button>
                    <button class="primary" id="exportJsonBtn">ØªØµØ¯ÙŠØ± JSON</button>
                    <button id="shareJsonBtn">Ù…Ø´Ø§Ø±ÙƒØ© JSON</button>
                  </div>

                  <label style="margin-top:10px;">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</label>
                  <input id="importJsonFile" type="file" accept="application/json" />
                  <div class="btns" style="justify-content:center;"><button id="importJsonBtn">Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ¯Ù…Ø¬</button></div>
                </div>
              </details>
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>

<script src="Question_bank.js"></script>

<script>
/* =========================================================
   Constants / Keys
========================================================= */

if (!window.QUESTION_BANK || typeof window.QUESTION_BANK !== "object") {
  alert("Question_bank.js Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ù„Ù ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯ ÙˆØ£Ù† Ø§Ù„Ø§Ø³Ù… ØµØ­ÙŠØ­.");
  throw new Error("QUESTION_BANK missing");
}

const QUESTION_BANK = window.QUESTION_BANK;

function assertQuestionBank(bank){
  const issues=[];
  if(!bank || typeof bank!=="object") issues.push("Bank root is not an object");

  for(const [subject, obj] of Object.entries(bank||{})){
    if(!obj || typeof obj!=="object"){
      issues.push(`"${subject}" is not an object`);
      continue;
    }
    for(const lvl of ["easy","medium","hard"]){
      if(!Array.isArray(obj[lvl])){
        issues.push(`"${subject}.${lvl}" is missing or not an array`);
      }
    }
  }

  if(issues.length){
    console.error("QUESTION_BANK issues:", issues);
    alert("ÙŠÙˆØ¬Ø¯ Ø®Ù„Ù„ ÙÙŠ Question_bank.js (Ø¨Ù†ÙŠØ© Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©). Ø§ÙØªØ­ÙŠ Console Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„.");
    throw new Error("Invalid QUESTION_BANK structure");
  }
}
assertQuestionBank(QUESTION_BANK);

const LS = Object.freeze({
  THEME: "qa_school_theme_v1",
  AUTO_NEXT: "qa_school_auto_next_v1",
  STARS: "qa_school_stars_v1",
  RESULTS: "qa_school_results_v1",
  SYNCED: "qa_school_synced_keys_v1",
  DEVICE_ID: "qa_school_device_id_v1",
  SCROLL_ADMIN: "qa_school_scroll_admin_panel_v1",
});

const IMAGE_EXTS = ["png","jpg","jpeg","webp"];
const LOGO_BASES  = ["logo.only","logo","Logo"];
const BANNER_BASES= ["Main","main","banner","Banner"];

const DEFAULT_STAR_NAMES = ["ÙØ§Ø·Ù…Ø© Ù†Ø§ØµØ± Ø§Ù„Ù…Ø¹Ø¬Ù…","Ù„Ù…Ø§Ø± Ø£Ù†Ø³ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ","Ø³Ø§Ø±Ø© Ø®Ø§Ù„Ø¯ Ø§Ù„ØµÙŠØ¹Ø±ÙŠ","Ù„ÙŠÙ†Ø§ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¹Ù…Ø±ÙŠ"];

const DEFAULT_GS_URL    = "https://script.google.com/macros/s/AKfycbx7fnqiT27URTW2mzC-Y1rJRi1rhNd7HXQd4YG_V6qILU1blWKDgiz_wNuJm6e-4yEA/exec";
const DEFAULT_GS_SECRET = "SV-QA-2026";

const ADMIN_USER = "Lolo";
const ADMIN_PASS = "Lamar";

const SCREENS = ["screenHome","screenSetup","screenQuiz","screenResult","screenBoard","screenAdmin"];

/* =========================================================
   Utilities
========================================================= */
const $ = (id)=>document.getElementById(id);

/* Non-blocking confirm (does NOT pause timers) */
let _confirmResolve = null;
function showConfirm(message, okText="Ù…ÙˆØ§ÙÙ‚", cancelText="Ø¥Ù„ØºØ§Ø¡"){
  return new Promise((resolve)=>{
    _confirmResolve = resolve;
    const ov = $("confirmOverlay");
    if(!ov || !$("confirmMsg") || !$("confirmOkBtn") || !$("confirmCancelBtn")){
      resolve(window.confirm(message));
      return;
    }
    $("confirmMsg").textContent = message;
    $("confirmOkBtn").textContent = okText;
    $("confirmCancelBtn").textContent = cancelText;
    ov.classList.add("show");
    ov.setAttribute("aria-hidden","false");
    // keep focus on cancel by default (safer)
    $("confirmCancelBtn").focus();
  });
}
function closeConfirm(answer){
  const ov = $("confirmOverlay");
  ov.classList.remove("show");
  ov.setAttribute("aria-hidden","true");
  const r = _confirmResolve;
  _confirmResolve = null;
  if(r) r(!!answer);
}

function pad2(n){ return String(n).padStart(2,"0"); }
function fmtDate(iso){
  const d=new Date(iso);
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g,(m)=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m]));
}
function buildCandidates(baseNames, exts){
  const out=[];
  baseNames.forEach(base=> exts.forEach(ext=> out.push(`${base}.${ext}`)));
  return out;
}

const LOGO_CANDIDATES   = buildCandidates(LOGO_BASES, IMAGE_EXTS);
const BANNER_CANDIDATES = buildCandidates(BANNER_BASES, IMAGE_EXTS);

function setImageWithFallback(imgEl, candidates, onAllFail){
  let i=0;
  const tryNext=()=>{
    if(i>=candidates.length){
      if(typeof onAllFail==="function") onAllFail();
      return;
    }
    const src=candidates[i++];
    imgEl.onerror=tryNext;
    imgEl.onload=()=>{ imgEl.onerror=null; imgEl.onload=null; };
    imgEl.src=src;
  };
  tryNext();
}
function showLogoFallback(){
  const box=document.querySelector(".logoBox");
  const img=$("siteLogo");
  if(img) img.style.display="none";
  if(box && !box.querySelector(".logoFallback")){
    const fb=document.createElement("div");
    fb.className="logoFallback";
    fb.textContent="TLG";
    box.appendChild(fb);
  }
}
function showBannerFallback(){
  const banner=$("mainBannerHome");
  if(banner) banner.style.display="none";
}

/* =========================================================
   Theme
========================================================= */
function applyTheme(theme){
  const t = (theme==="school") ? "school" : "midnight";
  document.documentElement.setAttribute("data-theme", t);
  localStorage.setItem(LS.THEME, t);
}
function toggleTheme(){
  const current = document.documentElement.getAttribute("data-theme") || "midnight";
  applyTheme(current==="midnight" ? "school" : "midnight");
}

/* =========================================================
   Scroll Memory (Admin only)
========================================================= */
function getScrollY(){
  return window.scrollY || document.documentElement.scrollTop || document.body.scrollTop || 0;
}
function setScrollY(y){
  window.scrollTo({ top: Math.max(0, Number(y||0)), behavior: "auto" });
}
function saveScroll(key){
  try{ localStorage.setItem(key, String(getScrollY())); }catch(e){}
}
function restoreScroll(key){
  let y=0;
  try{ y=parseFloat(localStorage.getItem(key)||"0"); }catch(e){ y=0; }
  setTimeout(()=>setScrollY(isFinite(y)?y:0), 0);
}

/* =========================================================
   App State
========================================================= */
let app = {
  mode:"normal", // normal | smart_challenge
  student:{name:"",grade:"Ø£ÙˆÙ„ Ù…ØªÙˆØ³Ø·"},
  subject:"",
  difficulty:"easy",
  questions:[],
  index:0,
  answers:[],
  startedAt:null,
  ui:{ currentScreen:"screenHome", lastBeforeBoard:"screenHome" }
};

let smartChallengeEnabled=false;
let smartTimerId=null;
let smartRemaining=0;
let smartAdvanceTimeout=null;

function setSmartChallengeUI(on){
  smartChallengeEnabled=!!on;
  const subjRow = $("subjectPick")?.closest(".row");
  if(subjRow) subjRow.style.display = on ? "none" : "";
  const hint=$("smartChallengeHint");
  if(hint) hint.style.display = on ? "" : "none";
  if(on){
    if($("subjectPick")) $("subjectPick").value="";
    if($("difficultyPick")) $("difficultyPick").value="";
  }
  renderSetupNotes();
}

function renderSetupNotes(){
  const tag=$("setupNotesModeTag");
  const box=$("setupNotesText");
  const card=$("setupNotesCard");
  if(!box) return;

  if(smartChallengeEnabled){
    if(tag) tag.innerHTML = '<span class="dangerText" style="font-weight:950;">ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡</span>';
    if(card) card.classList.add("notesDanger");
    box.innerHTML = `
      <div style="font-weight:950; font-size:var(--fs-13);">â€¢ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§ Ù…Ù† <b>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯</b> â€” <b>ØµØ¹Ø¨</b> ÙÙ‚Ø·.</div>
      <div style="font-weight:950; font-size:var(--fs-13);">â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: <b>10</b>.</div>
      <div style="font-weight:950; font-size:var(--fs-13);">â€¢ Ø§Ù„ÙˆÙ‚Øª: <b>15 Ø«Ø§Ù†ÙŠØ©</b> Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„.</div>
      <div style="font-weight:950; font-size:var(--fs-13);">â€¢ Ø¢Ù„ÙŠØ© Ø§Ù„ØªÙ‚Ø¯Ù…: <b>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</b> Ø£Ùˆ <b>Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª</b> â‡’ Ø§Ù†ØªÙ‚Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ.</div>
      <div style="font-weight:950; font-size:var(--fs-13);">â€¢ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: <b>8 Ù†Ù‚Ø§Ø·</b> Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„.</div>
    `;
  }else{
    if(tag) tag.textContent = "Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©";
    if(card) card.classList.remove("notesDanger");
    box.innerHTML = `
      <div>â€¢ ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø­Ø³Ø¨ <b>Ø§Ù„Ù…Ø§Ø¯Ø©</b> Ùˆ<b>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©</b> Ø§Ù„Ù…Ø®ØªØ§Ø±ÙŠÙ†.</div>
      <div>â€¢ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</div>
      <div style="margin-right:14px;">
        <div><b>3</b> Ù†Ù‚Ø§Ø· Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¨Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ù‡Ù„.</div>
        <div><b>4</b> Ù†Ù‚Ø§Ø· Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¨Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…ØªÙˆØ³Ø·.</div>
        <div><b>5</b> Ù†Ù‚Ø§Ø· Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¨Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹Ø¨.</div>
      </div>
      <div>â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: <b>10</b> Ø£Ø³Ø¦Ù„Ø©.</div>
      <div>â€¢ Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø³ÙŠØªÙ… Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ.</div>
    `;
  }
}

function stopSmartTimer(){
  if(smartTimerId){ clearInterval(smartTimerId); smartTimerId=null; }
  if(smartAdvanceTimeout){ clearTimeout(smartAdvanceTimeout); smartAdvanceTimeout=null; }

  // hide any inline timer UI remnants
  const inline=$("smartTimerInline");
  if(inline) inline.style.display="none";
  if(inline) inline.classList.remove("timerUrgent");
}
function startSmartTimer(){
  stopSmartTimer();

  const inline=$("smartTimerInline");
  if(inline) inline.style.display="block";

  smartRemaining=15;
  const total=15;

  const n2=$("smartTimerNum2");
  const fill=$("smartTimerFill");

  if(fill) fill.style.width = "100%";
  if(n2) n2.textContent = smartRemaining;

  const update=()=>{
    const frac = Math.max(0, smartRemaining) / total;
    if(fill) fill.style.width = `${Math.max(0, frac)*100}%`;
    if(n2) n2.textContent = Math.max(0, smartRemaining);

    if(inline){
      if(smartRemaining<=5 && smartRemaining>0) inline.classList.add("timerUrgent");
      else inline.classList.remove("timerUrgent");
    }
  };

  update();

  smartTimerId=setInterval(()=>{
    smartRemaining--;
    update();

    if(smartRemaining<=0){
      stopSmartTimer();
      if(app.answers?.[app.index]?.value===null){
        autoAdvanceSmart();
      }
    }
  }, 1000);
}
function autoAdvanceSmart(){
  const total=app.questions.length;
  const isLast=app.index===total-1;
  if(isLast){
    finishQuiz(true);
  }else{
    app.index++;
    renderQuestion();
  }
}

let admin = { loggedIn:false };

/* =========================================================
   Router
========================================================= */
const SCREEN_ROUTE = {
  screenHome:  "",
  screenSetup: "setup",
  screenQuiz:  "quiz",
  screenResult:"result",
  screenBoard: "board",
  screenAdmin: "admin"
};


function routeToScreen(route){
  const r = String(route||"").replace(/^#/, "");
  const entry = Object.entries(SCREEN_ROUTE).find(([,v]) => v === r);
  return entry ? entry[0] : "screenHome";
}

function setRouteForScreen(screenId, mode){
  const route = SCREEN_ROUTE[screenId];
  if(route === undefined) return;

  const url = route ? `#${route}` : "#";
  const state = { screen: screenId };

  if(mode === "replace"){
    history.replaceState(state, "", url);
  }else{
    history.pushState(state, "", url);
  }
}

  
  function show(screenId, opts = {}){
  const prev = app.ui.currentScreen;
  const { history = true, replace = false } = opts;

  if(prev==="screenAdmin") saveScroll(LS.SCROLL_ADMIN);

  SCREENS.forEach(s=>{
    const el=$(s);
    if(el) el.style.display = (s===screenId) ? "block" : "none";
  });

  app.ui.currentScreen = screenId;

  // History handling
  if(history){
    setRouteForScreen(screenId, replace ? "replace" : "push");
  }

  // Safety: stop smart timer when navigating away from quiz (or returning home)
  if(prev==="screenQuiz" && screenId!=="screenQuiz") stopSmartTimer();
  if(screenId==="screenHome") stopSmartTimer();
  if(screenId==="screenAdmin") restoreScroll(LS.SCROLL_ADMIN);

  // brand hidden on home
  const brand=$("headerBrand");
  if(brand) brand.style.display=(screenId==="screenHome") ? "none" : "flex";

  // header layout when only actions exist (home)
  const hdr=$("appHeader");
  if(hdr) hdr.classList.toggle("homeOnly", screenId==="screenHome");

  // header icons visibility rules
  const homeBtn=$("homeHeaderBtn");
  const adminBtn=$("adminHeaderBtn");
  if(homeBtn) homeBtn.style.display=(screenId==="screenHome") ? "none" : "grid";
  if(adminBtn) adminBtn.style.display=(screenId==="screenAdmin") ? "none" : "grid";
}





/* =========================================================
   Device + Result Keys
========================================================= */
function getDeviceId(){
  let v=localStorage.getItem(LS.DEVICE_ID);
  if(!v){
    v="dev_"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16);
    localStorage.setItem(LS.DEVICE_ID, v);
  }
  return v;
}
function minuteStamp(iso){
  const d=new Date(iso);
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function resultKey(r){
  const m=minuteStamp(r.date);
  return `${getDeviceId()}|${(r.name||"").trim()}|${(r.grade||"").trim()}|${(r.subject||"").trim()}|${m}`;
}

/* =========================================================
   LocalStorage Results
========================================================= */
function getResults(){
  try{
    const raw=localStorage.getItem(LS.RESULTS);
    return raw ? JSON.parse(raw) : [];
  }catch(e){ return []; }
}
function saveResults(items){ localStorage.setItem(LS.RESULTS, JSON.stringify(items)); }
function sortResults(items){
  return items.sort((a,b)=>{
    if(b.score!==a.score) return b.score-a.score;
    return new Date(b.date)-new Date(a.date);
  });
}
function getSyncedKeys(){
  try{
    const raw=localStorage.getItem(LS.SYNCED);
    if(!raw) return new Set();
    const arr=JSON.parse(raw);
    return new Set(Array.isArray(arr)?arr:[]);
  }catch(e){ return new Set(); }
}
function saveSyncedKeys(setObj){
  localStorage.setItem(LS.SYNCED, JSON.stringify(Array.from(setObj)));
}

/* =========================================================
   Stars (LocalStorage)
========================================================= */
function normalizeStarName(s){ return String(s||"").trim().replace(/\s+/g," "); }
function getStarNames(){
  try{
    const raw=localStorage.getItem(LS.STARS);
    if(!raw) return DEFAULT_STAR_NAMES.slice();
    const arr=JSON.parse(raw);
    if(!Array.isArray(arr)) return DEFAULT_STAR_NAMES.slice();
    const cleaned=arr.map(normalizeStarName).filter(x=>x.length>0);
    return cleaned.length ? cleaned : DEFAULT_STAR_NAMES.slice();
  }catch(e){ return DEFAULT_STAR_NAMES.slice(); }
}
function saveStarNames(list){
  const cleaned=(list||[]).map(normalizeStarName).filter(x=>x.length>0);
  localStorage.setItem(LS.STARS, JSON.stringify(cleaned));
}
function renderStars(targetId){
  const el=$(targetId);
  if(!el) return;
  const STAR_NAMES=getStarNames();
  el.innerHTML="";
  STAR_NAMES.forEach((name,idx)=>{
    const pill=document.createElement("div");
    pill.className="starName";
    const star=document.createElement("span");
    star.className="star";
    star.style.animationDelay=`${idx*0.2}s`;
    star.textContent="â˜…";
    const txt=document.createElement("span");
    txt.textContent=name;
    pill.appendChild(star);
    pill.appendChild(txt);
    el.appendChild(pill);
  });
}

/* =========================================================
   Auto Next
========================================================= */
function getAutoNext(){
  const v=localStorage.getItem(LS.AUTO_NEXT);
  return v===null ? true : (v==="1");
}
function setAutoNext(v){ localStorage.setItem(LS.AUTO_NEXT, v ? "1":"0"); }

/* =========================================================
   Subject Picker
========================================================= */
function initSubjectPick(){
  const sel=$("subjectPick");
  if(!sel) return;
  Object.keys(QUESTION_BANK).forEach(sub=>{
    const opt=document.createElement("option");
    opt.value=sub; opt.textContent=sub;
    sel.appendChild(opt);
  });
}

/* =========================================================
   Setup validation
========================================================= */
function validateSetup(){
  const name=($("studentName")?.value||"").trim();
  const grd=$("studentGrade")?.value||"";
  const subj=$("subjectPick")?.value||"";
  const diff=$("difficultyPick")?.value||"";
  const allowed=new Set(["easy","medium","hard"]);

  if(smartChallengeEnabled){
    if(!name||!grd) return {ok:false,msg:"Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ØµÙ."};
    return {ok:true};
  }

  if(!name||!subj||!grd||!allowed.has(diff)) return {ok:false,msg:"Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ØµÙ ÙˆØ§Ù„Ù…Ø§Ø¯Ø© ÙˆÙ…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©."};
  return {ok:true};
}

/* =========================================================
   Quiz
========================================================= */
function shuffleArray(arr){
  const a=arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function difficultyLabel(d){
  if(d==="easy") return "Ø³Ù‡Ù„";
  if(d==="medium") return "Ù…ØªÙˆØ³Ø·";
  if(d==="hard") return "ØµØ¹Ø¨";
  return "â€”";
}

function startQuiz(){
  const v=validateSetup();
  if(!v.ok){ alert(v.msg); return; }

  app.student.name = ($("studentName").value||"").trim();
  app.student.grade = $("studentGrade").value;

  if(smartChallengeEnabled){
    app.mode="smart_challenge";
    app.subject="ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡";
    app.difficulty="hard";

    const pool=[];
    Object.keys(QUESTION_BANK).forEach(sub=>{
      const b=QUESTION_BANK[sub];
      if(b && Array.isArray(b.hard)){
        b.hard.forEach(q=>pool.push({...q, __subject:sub}));
      }
    });

    if(pool.length<10){
      alert("Ø¹Ø¯Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹Ø¨ ØºÙŠØ± ÙƒØ§ÙÙ Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡ (ÙŠØ­ØªØ§Ø¬ 10 Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).");
      return;
    }

    const selected=shuffleArray(pool).slice(0,10);
    app.questions=selected.map(q=>({...q}));
    app.index=0;
    app.answers=app.questions.map(()=>({value:null}));
    app.startedAt=new Date().toISOString();

    $("whoBadge").textContent=`${app.student.name}`;
    $("subjectBadge").innerHTML=`<span class="dangerText">ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡</span>`;
    $("qCountBadge").textContent=`Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${app.questions.length}`;
    $("diffBadge").textContent=`Ø§Ù„ØµØ¹ÙˆØ¨Ø©: ØµØ¹Ø¨`;

    show("screenQuiz");
    renderQuestion();
    return;
  }

  app.mode="normal";
  app.subject = $("subjectPick").value;
  app.difficulty = $("difficultyPick").value;

  const bank=QUESTION_BANK[app.subject];
  let picked=[];
  if(app.difficulty==="easy") picked=bank.easy.slice();
  else if(app.difficulty==="medium") picked=bank.medium.slice();
  else picked=bank.hard.slice();

  const shuffled=shuffleArray(picked);
  const selected=shuffled.slice(0, Math.min(10, shuffled.length));
  app.questions=selected.map(q=>({...q}));

  app.index=0;
  app.answers=app.questions.map(()=>({value:null}));
  app.startedAt=new Date().toISOString();

  $("whoBadge").textContent=`${app.student.name}`;
  $("subjectBadge").textContent=`Ø§Ù„Ù…Ø§Ø¯Ø©: ${app.subject}`;
  $("qCountBadge").textContent=`Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${app.questions.length}`;
  $("diffBadge").textContent=`Ø§Ù„ØµØ¹ÙˆØ¨Ø©: ${difficultyLabel(app.difficulty)}`;

  show("screenQuiz");
  renderQuestion();
}

function renderQuestion(){
  const q=app.questions[app.index];
  const total=app.questions.length;
  const pct=Math.round(((app.index+1)/Math.max(1,total))*100);

  $("progressFill").style.width=`${pct}%`;
  $("qText").textContent=`Ø³${app.index+1}: ${q.question}`;
  $("qType").textContent=(q.type==="mcq"?"Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯":"ØµØ­ / Ø®Ø·Ø£");

  // Remaining questions badge
  const remaining = Math.max(0, total - app.index);
  const qBadge = $("qCountBadge");
  if(qBadge) qBadge.textContent = `Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${remaining}`;

  const box=$("answersBox");
  box.innerHTML="";

  if(q.type==="mcq"){
    q.options.forEach((optText,i)=>{
      const label=document.createElement("label");
      label.className="opt";
      label.innerHTML=`<input type="radio" name="ans" value="${i}" /><div>${escapeHtml(optText)}</div>`;
      label.querySelector("input").addEventListener("change",()=>setAnswer(i));
      box.appendChild(label);
    });

    const saved=app.answers[app.index].value;
    if(typeof saved==="number"){
      const radios=box.querySelectorAll('input[type="radio"]');
      radios.forEach(r=>{ if(Number(r.value)===saved) r.checked=true; });
    }
  }else{
    [{val:true,text:"ØµØ­"},{val:false,text:"Ø®Ø·Ø£"}].forEach(o=>{
      const label=document.createElement("label");
      label.className="opt";
      label.innerHTML=`<input type="radio" name="ans" value="${o.val}" /><div>${o.text}</div>`;
      label.querySelector("input").addEventListener("change",()=>setAnswer(o.val));
      box.appendChild(label);
    });

    const saved=app.answers[app.index].value;
    if(typeof saved==="boolean"){
      const radios=box.querySelectorAll('input[type="radio"]');
      radios.forEach(r=>{ if((r.value==="true")===saved) r.checked=true; });
    }
  }

  // Smart Challenge timer
  if(app.mode==="smart_challenge") startSmartTimer();
  else stopSmartTimer();

  const isLast=app.index===total-1;

  if(app.mode==="smart_challenge"){
    $("prevBtn").style.display="none";
    $("nextBtn").style.display="none";
    $("finishBtn").style.display="none";
    $("liveHint").textContent="";
  }else{
    $("prevBtn").style.display="";
    $("nextBtn").style.display=isLast?"none":"inline-block";
    $("finishBtn").style.display=isLast?"inline-block":"none";
    $("prevBtn").disabled=app.index===0;
    $("liveHint").textContent="";
  }
}

function setAnswer(val){
  app.answers[app.index].value=val;

  // Smart Challenge: stop timer and auto-advance immediately
  if(app.mode==="smart_challenge"){
    stopSmartTimer();
    smartAdvanceTimeout = setTimeout(()=>autoAdvanceSmart(), 120);
    return;
  }

  // Normal mode: optional auto-next (Admin setting)
  if(getAutoNext()){
    const total=app.questions.length;
    const isLast=app.index===total-1;
    if(isLast){
      setTimeout(()=>finishQuiz(), 120);
    }else{
      setTimeout(()=>nextQ(), 120);
    }
  }
}
function nextQ(){
  if(app.answers[app.index].value===null){ alert("Ø§Ø®ØªØ§Ø±ÙŠ Ø¥Ø¬Ø§Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹."); return; }
  const total = app.questions.length;
  if(app.index >= total-1){
    finishQuiz();
    return;
  }
  app.index++;
  renderQuestion();
}
function prevQ(){ app.index--; renderQuestion(); }

function resetAttempt(){
  showConfirm("Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø¹ÙˆØ¯Ø©ØŸ","Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©","Ù…ØªØ§Ø¨Ø¹Ø©").then((ok)=>{
    if(!ok) return;
    stopSmartTimer();
    show("screenSetup");
  });
}

function finishQuiz(force=false){
  if(!force && app.mode!=="smart_challenge" && app.answers[app.index].value===null){ alert("Ø§Ø®ØªØ§Ø±ÙŠ Ø¥Ø¬Ø§Ø¨Ø© Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ø®ÙŠØ±."); return; }

  const qCount=app.questions.length;
  const pointsPerCorrect =
    (app.mode==="smart_challenge") ? 8 :
    (app.difficulty==="hard") ? 5 :
    (app.difficulty==="medium") ? 4 : 3;

  let correctCount=0;
  let points=0;

  for(let i=0;i<qCount;i++){
    const isCorrect=(app.answers[i].value===app.questions[i].answer);
    if(isCorrect){ correctCount++; points += pointsPerCorrect; }
  }

  const totalPoints = qCount * pointsPerCorrect;
  const pct = totalPoints>0 ? Math.round((points/totalPoints)*100) : 0;

  const item={
    deviceId:getDeviceId(),
    key:"",
    name:app.student.name,
    grade:app.student.grade,
    subject:app.subject,
    difficulty:app.difficulty,
    mode: app.mode,
    label: (app.mode==="smart_challenge") ? "ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡" : "",
    subjectNote: (app.mode==="smart_challenge") ? "Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯" : "",
    score: points,
    total: totalPoints,
    percent: pct,
    correctCount,
    questionCount: qCount,
    pointsPerCorrect,
    date:new Date().toISOString()
  };

  item.key=resultKey(item);
  saveResults(sortResults([...getResults(), item]));

  // Auto-upload (silent)
  pushUnsyncedToGoogleSheet({silent:true});

  if(app.mode==="smart_challenge"){
    $("resultTitle").textContent=`${app.student.name}`;
  }else{
    $("resultTitle").textContent=`${app.student.name} â€” ${app.subject}`;
  }
  $("resultMeta").textContent=`${app.student.grade} â€” ${difficultyLabel(app.difficulty)} â€” ${fmtDate(item.date)}`;
  $("scoreBig").textContent=`${points} / ${totalPoints} (${pct}%)`;

  let badgeText="Ù…Ù…ØªØ§Ø²";
  if(pct<60) badgeText="ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†";
  else if(pct<80) badgeText="Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹";
  $("scoreBadge").textContent=badgeText;

  $("reviewNote").textContent="ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©.";
  renderReview();
  show("screenResult");
}

function renderReview(){
  const list=$("reviewList");
  list.innerHTML="";
  app.questions.forEach((q,i)=>{
    const a=app.answers[i].value;
    const isCorrect=(a===q.answer);
    const your=(q.type==="mcq")?(a===null?"â€”":q.options[a]):(a===null?"â€”":(a?"ØµØ­":"Ø®Ø·Ø£"));
    const right=(q.type==="mcq")?q.options[q.answer]:(q.answer?"ØµØ­":"Ø®Ø·Ø£");
    const div=document.createElement("div");
    div.className="card";
    div.style.padding="var(--pad)";
    div.innerHTML=`
      <div class="topline">
        <div style="font-weight:800;">Ø³${i+1}: ${escapeHtml(q.question)}</div>
        <div class="pill ${isCorrect?'ok':'bad'}">${isCorrect?"ØµØ­ÙŠØ­":"Ø®Ø·Ø£"}</div>
      </div>
      <div class="hint" style="margin-top:6px;">
        Ø¥Ø¬Ø§Ø¨ØªÙƒ: <b>${escapeHtml(your)}</b>
        ${isCorrect ? "" : `<br/>Ø§Ù„ØµØ­ÙŠØ­: <b>${escapeHtml(right)}</b>`}
      </div>
    `;
    list.appendChild(div);
  });
}

/* =========================================================
   Board (smart back)
========================================================= */
function openBoard(fromScreen){
  app.ui.lastBeforeBoard = fromScreen || app.ui.currentScreen || "screenHome";
  renderBoard();
  show("screenBoard");
}
function backFromBoard(){
  const target = app.ui.lastBeforeBoard || "screenHome";
  show(target);
}
function renderBoard(){
  const body=$("boardBody");
  body.innerHTML="";
  const board=sortResults(getResults());
  if(board.length===0){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td colspan="6" class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯.</td>`;
    body.appendChild(tr);
    return;
  }
  board.slice(0,50).forEach((r,idx)=>{
    if(!r.key) r.key=resultKey(r);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${idx+1}</td>
      <td>${escapeHtml(r.name)}</td>
      <td>${escapeHtml(r.grade)}</td>
      <td>${
        (r.mode==="smart_challenge")
          ? `<span class="dangerText">ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡</span><div class="small">Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯ â€” ØµØ¹Ø¨</div>`
          : `${escapeHtml(r.subject)}<div class="small">${difficultyLabel(r.difficulty||"")}</div>`
      }</td>
      <td>
        <b>${r.score}/${r.total}</b> <span class="small">(${r.percent}%)</span>
        ${typeof r.correctCount==="number" && typeof r.questionCount==="number"
          ? `<div class="small">ØµØ­ÙŠØ­: ${r.correctCount}/${r.questionCount}</div>`
          : ``}
      </td>
      <td class="small">${fmtDate(r.date)}</td>
    `;
    body.appendChild(tr);
  });
}

/* =========================================================
   Admin: Export/Import + Local delete
========================================================= */
function toCsv(items){
  const header=["deviceId","key","name","grade","subject","difficulty","score","total","percent","date"];
  const esc=(v)=>`"${String(v??"").replace(/"/g,'""')}"`;
  const rows=items.map(r=>header.map(k=>esc(r[k])).join(","));
  return header.join(",")+"\n"+rows.join("\n");
}
function downloadBlob(content,filename,mime){
  const blob=new Blob([content],{type:mime});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
async function shareFile(filename,content,mime){
  const blob=new Blob([content],{type:mime});
  const file=new File([blob],filename,{type:mime});
  if(navigator.canShare && navigator.canShare({files:[file]}) && navigator.share){
    await navigator.share({title:"Ù†ØªØ§Ø¦Ø¬",files:[file]});
    return true;
  }
  return false;
}

function mergeResults(existing,incoming){
  const map=new Map();
  existing.forEach(r=>map.set(r.key||resultKey(r),r));
  incoming.forEach(r=>{
    const k=r.key||resultKey(r);
    if(!map.has(k)){
      r.deviceId=r.deviceId||getDeviceId();
      r.key=r.key||k;
      map.set(k,r);
    }
  });
  return sortResults(Array.from(map.values()));
}

function renderAdminState(){
  const logoutBtn=$("logoutBtn");
  const loginBox=$("adminLoginBox");
  const panelBox=$("adminPanelBox");

  if(logoutBtn) logoutBtn.style.display=admin.loggedIn?"inline-block":"none";
  if(loginBox) loginBox.style.display=admin.loggedIn?"none":"block";
  if(panelBox) panelBox.style.display=admin.loggedIn?"block":"none";

  if(admin.loggedIn){
    const adminCount=$("adminCount");
    if(adminCount) adminCount.textContent=`Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${getResults().length}`;
    refreshSyncNote();
    renderAdminManage();
    refreshStarsAdminUI();
    const t=$("autoNextToggle");
    if(t) t.checked=getAutoNext();
  }
}

function openAdmin(){
  app.ui.adminReturnScreen = app.ui.currentScreen;
  show("screenAdmin");
  $("adminUser").value="";
  $("adminPass").value="";
  $("gsUrlView").textContent=DEFAULT_GS_URL;
  renderAdminState();
  refreshStarsAdminUI();
  initQuestionBankUI(true);
}

function adminLogin(){
  const u=($("adminUser")?.value||"").trim();
  const p=($("adminPass")?.value||"").trim();
  if(u===ADMIN_USER && p===ADMIN_PASS){
    admin.loggedIn=true;
    renderAdminState();
  } else {
    alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
  }
}
function adminLogout(){
  admin.loggedIn=false;
  renderAdminState();
  show("screenHome");
}

function exportCsv(){
  const csv=toCsv(sortResults(getResults()));
  downloadBlob(csv,`results_${new Date().toISOString().slice(0,10)}.csv`,"text/csv;charset=utf-8");
}
function exportJson(){
  const payload={exportedAt:new Date().toISOString(),deviceId:getDeviceId(),results:sortResults(getResults())};
  downloadBlob(JSON.stringify(payload,null,2),`results_${new Date().toISOString().slice(0,10)}.json`,"application/json;charset=utf-8");
}
async function shareJson(){
  const payload={exportedAt:new Date().toISOString(),deviceId:getDeviceId(),results:sortResults(getResults())};
  const json=JSON.stringify(payload,null,2);
  const filename=`results_${new Date().toISOString().slice(0,10)}.json`;
  try{
    const ok=await shareFile(filename,json,"application/json");
    if(!ok) downloadBlob(json,filename,"application/json;charset=utf-8");
  }catch(e){
    downloadBlob(json,filename,"application/json;charset=utf-8");
  }
}
async function importJson(){
  const fileInput=$("importJsonFile");
  if(!fileInput.files||!fileInput.files[0]){ alert("Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ù„Ù JSON Ø£ÙˆÙ„Ø§Ù‹."); return; }
  const text=await fileInput.files[0].text();
  let parsed;
  try{ parsed=JSON.parse(text); }catch(e){ alert("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­."); return; }
  const incoming=parsed.results||parsed;
  if(!Array.isArray(incoming)){ alert("ØµÙŠØºØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©."); return; }
  const merged=mergeResults(getResults(),incoming);
  saveResults(merged);
  alert(`ØªÙ… Ø§Ù„Ø¯Ù…Ø¬. Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${merged.length}`);
  renderAdminState();
}

function deleteOneResultLocal(key){
  if(!key) return;
  if(!confirm("Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŸ")) return;
  const results=getResults().filter(x=>x.key!==key);
  saveResults(results);
  try{
    const synced=getSyncedKeys();
    synced.delete(key);
    saveSyncedKeys(synced);
  }catch(e){}
  renderAdminState();
}
function clearLocalResults(){
  if(!confirm("Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŸ")) return;
  localStorage.removeItem(LS.RESULTS);
  localStorage.removeItem(LS.SYNCED);
  renderAdminState();
}

function renderAdminManage(){
  const items=sortResults(getResults());
  const countEl=$("adminManageCount");
  if(countEl) countEl.textContent=`Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${items.length}`;

  const body=$("adminManageBody");
  if(!body) return;

  body.innerHTML="";
  if(items.length===0){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td colspan="7" class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</td>`;
    body.appendChild(tr);
    return;
  }

  items.slice(0,200).forEach((r,idx)=>{
    if(!r.key) r.key=resultKey(r);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${idx+1}</td>
      <td>${escapeHtml(r.name)}</td>
      <td>${escapeHtml(r.grade)}</td>
      <td>${escapeHtml(r.subject)}</td>
      <td><b>${r.score}/${r.total}</b> <span class="small">(${r.percent}%)</span></td>
      <td class="small">${fmtDate(r.date)}</td>
      <td><button class="danger" data-del="${r.key}">Ø­Ø°Ù</button></td>
    `;
    body.appendChild(tr);
    tr.querySelector("button[data-del]").addEventListener("click",()=>deleteOneResultLocal(r.key));
  });
}

/* =========================================================
   Stars Admin UI
========================================================= */
function refreshStarsAdminUI(){
  const names=getStarNames();
  const ta=$("starsTextarea");
  if(ta) ta.value=names.join("\n");
  const badge=$("starsCountBadge");
  if(badge) badge.textContent=`Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡: ${names.length}`;
  const note=$("starsSaveNote");
  if(note) note.textContent="";
}
function applyStarsEverywhere(){
  renderStars("starsHome");
  const badge=$("starsCountBadge");
  if(badge){
    const names=getStarNames();
    badge.textContent=`Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡: ${names.length}`;
  }
}
function saveStarsFromAdmin(){
  const ta=$("starsTextarea");
  if(!ta) return;
  const lines=ta.value.split("\n").map(normalizeStarName).filter(Boolean);
  if(lines.length===0){ alert("Ø£Ø¯Ø®Ù„ÙŠ Ø§Ø³Ù…Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„."); return; }
  const seen=new Set();
  const unique=[];
  for(const n of lines){ if(!seen.has(n)){ seen.add(n); unique.push(n); } }
  saveStarNames(unique);
  applyStarsEverywhere();
  const note=$("starsSaveNote");
  if(note) note.textContent="ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶.";
}
function resetStarsToDefault(){
  localStorage.removeItem(LS.STARS);
  refreshStarsAdminUI();
  applyStarsEverywhere();
  const note=$("starsSaveNote");
  if(note) note.textContent="ØªÙ…Øª Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©.";
}

/* =========================================================
   Google Sheet Sync (no-cors as before)
========================================================= */
function refreshSyncNote(){
  const all=getResults();
  const synced=getSyncedKeys();
  const uns=all.filter(r=>!synced.has(r.key)).length;
  $("syncNote").textContent=`ØºÙŠØ± Ø§Ù„Ù…Ø±ÙÙˆØ¹: ${uns} | Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${all.length}`;
}
async function postToGoogleSheet(payload){
  await fetch(DEFAULT_GS_URL,{
    method:"POST",
    mode:"no-cors",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });
}
async function pushUnsyncedToGoogleSheet(opts={}){
  const silent=!!opts.silent;
  const all=sortResults(getResults());
  const synced=getSyncedKeys();
  const unsynced=all.filter(r=>!synced.has(r.key));

  if(unsynced.length===0){
    if(!silent) alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø±ÙØ¹.");
    refreshSyncNote();
    return;
  }

  const payload={
    secret:DEFAULT_GS_SECRET,
    deviceId:getDeviceId(),
    source:"QA School Project",
    pushedAt:new Date().toISOString(),
    results:unsynced
  };

  try{
    await postToGoogleSheet(payload);
    unsynced.forEach(r=>synced.add(r.key));
    saveSyncedKeys(synced);
    refreshSyncNote();
    if(!silent) alert(`ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${unsynced.length}`);
  }catch(e){
    if(!silent) alert("ØªØ¹Ø°Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.");
  }
}
async function pushAllToGoogleSheet(){
  const all=sortResults(getResults());
  if(all.length===0){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬."); return; }

  const payload={
    secret:DEFAULT_GS_SECRET,
    deviceId:getDeviceId(),
    source:"QA School Project",
    pushedAt:new Date().toISOString(),
    results:all
  };

  try{
    await postToGoogleSheet(payload);
    const synced=getSyncedKeys();
    all.forEach(r=>synced.add(r.key));
    saveSyncedKeys(synced);
    refreshSyncNote();
    alert(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙ„: ${all.length}`);
  }catch(e){
    alert("ØªØ¹Ø°Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.");
  }
}

/* =========================================================
   Question Bank UI (Admin)
========================================================= */
let qbInitDone=false;
function initQuestionBankUI(force=false){
  if(qbInitDone && !force) return;
  const subjSel=$("qbSubjectPick");
  const diffSel=$("qbDiffPick");
  if(!subjSel || !diffSel) return;

  if(!qbInitDone){
    subjSel.innerHTML="";

    // Placeholder: do not show questions until user selects
    const ph=document.createElement("option");
    ph.value=""; ph.textContent="â€” Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ø§Ø¯Ø© â€”";
    subjSel.appendChild(ph);

    Object.keys(QUESTION_BANK).forEach(sub=>{
      const opt=document.createElement("option");
      opt.value=sub; opt.textContent=sub;
      subjSel.appendChild(opt);
    });

    // Start with empty selection
    diffSel.value="";

    subjSel.addEventListener("change",renderQuestionBank);
    diffSel.addEventListener("change",renderQuestionBank);

    const resetBtn=$("qbResetBtn");
    if(resetBtn){
      resetBtn.addEventListener("click", ()=>{
        subjSel.value="";
        diffSel.value="";
        renderQuestionBank();
      });
    }
    qbInitDone=true;
  }
  renderQuestionBank();
}

function renderQuestionBank(){
  const subjSel=$("qbSubjectPick");
  const diffSel=$("qbDiffPick");
  const list=$("qbList");
  const badge=$("qbCountBadge");
  const lvlBadge=$("qbLevelCountBadge");
  if(!subjSel || !diffSel || !list) return;

  const subject=(subjSel.value||"").trim();
  const diff=(diffSel.value||"").trim();

  // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ù„ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯/Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª (ÙŠØ¸Ù‡Ø± Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ø­ØªÙ‰ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±)
  const grandTotal = Object.values(QUESTION_BANK).reduce((acc, bank)=>{
    const e = Array.isArray(bank && bank.easy) ? bank.easy.length : 0;
    const m = Array.isArray(bank && bank.medium) ? bank.medium.length : 0;
    const h = Array.isArray(bank && bank.hard) ? bank.hard.length : 0;
    return acc + e + m + h;
  }, 0);

  // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© (ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª) â€” Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø§Ø¯Ø© Ù…Ø­Ø¯Ø¯Ø©
  const bank = subject ? QUESTION_BANK[subject] : null;
  const subjectTotal = bank
    ? ( (Array.isArray(bank.easy) ? bank.easy.length : 0) +
        (Array.isArray(bank.medium) ? bank.medium.length : 0) +
        (Array.isArray(bank.hard) ? bank.hard.length : 0) )
    : 0;

  // Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: Ø¥Ù† ÙˆÙØ¬Ø¯Øª Ù…Ø§Ø¯Ø© Ù†Ø¹Ø±Ø¶ Ø¥Ø¬Ù…Ø§Ù„ÙŠÙ‡Ø§ØŒ ÙˆØ¥Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù…
  if(badge) badge.textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${subject ? subjectTotal : grandTotal}`;

  // Gate: Ù„Ø§ ØªÙØ¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø© + Ø§Ù„Ù…Ø³ØªÙˆÙ‰
  if(!subject || !diff){
    if(lvlBadge) lvlBadge.textContent="";
    list.innerHTML="";
    const div=document.createElement("div");
    div.className="small";
    div.textContent = (!subject)
      ? "Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ§Ù„Ù…Ø³ØªÙˆÙ‰ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©."
      : "Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©.";
    list.appendChild(div);
    return;
  }

  const qs=(bank && Array.isArray(bank[diff])) ? bank[diff] : [];

  // Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙÙ‚Ø·
  if(lvlBadge) lvlBadge.textContent=`Ø¹Ø¯Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${qs.length}`;
  list.innerHTML="";

  if(!qs.length){
    const div=document.createElement("div");
    div.className="small";
    div.textContent="Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±.";
    list.appendChild(div);
    return;
  }

  qs.forEach((q,idx)=>{
    const box=document.createElement("div");
    box.className="qbItem";

    const qText=document.createElement("p");
    qText.className="qbQ";
    qText.textContent=`Ø³${idx+1}: ${q.question}`;
    box.appendChild(qText);

    if(q.type==="mcq" && Array.isArray(q.options)){
      q.options.forEach((optText,i)=>{
        const opt=document.createElement("div");
        opt.className="qbOpt" + (i===q.answer ? " correct" : "");
        opt.innerHTML=`<div class="idx">${i+1}</div><div class="txt">${escapeHtml(optText)}</div>`;
        box.appendChild(opt);
      });
    }else{
      const opts=[{t:"ØµØ­",v:true},{t:"Ø®Ø·Ø£",v:false}];
      opts.forEach((o,i)=>{
        const isCorrect=(q.answer===o.v);
        const opt=document.createElement("div");
        opt.className="qbOpt" + (isCorrect ? " correct" : "");
        opt.innerHTML=`<div class="idx">${i+1}</div><div class="txt">${o.t}</div>`;
        box.appendChild(opt);
      });
    }

    list.appendChild(box);
  });
}

/* =========================================================
   Boot
========================================================= */
function boot(){
  applyTheme(localStorage.getItem(LS.THEME) || "midnight");

  const logoEl=$("siteLogo");
  if(logoEl) setImageWithFallback(logoEl, LOGO_CANDIDATES, showLogoFallback);

  const bannerHomeEl=$("mainBannerHome");
  if(bannerHomeEl) setImageWithFallback(bannerHomeEl, BANNER_CANDIDATES, showBannerFallback);

  renderStars("starsHome");
  initSubjectPick();
  renderSetupNotes();

  // Confirm modal wiring (event delegation) â€” avoids dead buttons even if modal is after scripts
  document.addEventListener("click",(e)=>{
    const t=e.target;
    if(!t) return;

    // buttons
    if(t.id==="confirmOkBtn"){ e.preventDefault(); closeConfirm(true); return; }
    if(t.id==="confirmCancelBtn"){ e.preventDefault(); closeConfirm(false); return; }

    // click outside box closes as cancel
    if(t.id==="confirmOverlay"){ e.preventDefault(); closeConfirm(false); return; }
  });

  // Escape closes confirm as cancel
  document.addEventListener("keydown",(e)=>{
    if(e.key==="Escape"){
      const ov=$("confirmOverlay");
      if(ov && ov.classList.contains("show")){
        e.preventDefault();
        closeConfirm(false);
      }
    }
  });


  const hb=$("homeHeaderBtn");
  if(hb) hb.addEventListener("click",()=>show("screenHome"));

  const ah=$("adminHeaderBtn");
  if(ah) ah.addEventListener("click",openAdmin);

  const tb=$("themeBtn");
  if(tb) tb.addEventListener("click",toggleTheme);

  const ant=$("autoNextToggle");
  if(ant) ant.addEventListener("change",e=>setAutoNext(e.target.checked));

  const qbDet=$("qbDetails");
  if(qbDet){
    qbDet.addEventListener("toggle", ()=>{
      if(qbDet.open) initQuestionBankUI(true);
    });
  }

  const resDet=$("resultsDetails");
  if(resDet){
    resDet.addEventListener("toggle", ()=>{
      if(resDet.open) renderAdminManage();
    });
  }

  const saveBtn=$("saveStarsBtn");
  if(saveBtn) saveBtn.addEventListener("click",saveStarsFromAdmin);

  const resetBtn=$("resetStarsBtn");
  if(resetBtn) resetBtn.addEventListener("click",resetStarsToDefault);

  $("goRegisterBtn").addEventListener("click", ()=>show("screenSetup"));
  $("viewBoardBtn").addEventListener("click", ()=>openBoard("screenSetup"));
  
$("smartChallengeBtn").addEventListener("click", ()=>{
  const on=!smartChallengeEnabled;
  setSmartChallengeUI(on);
  $("smartChallengeBtn").textContent = on ? "ØªÙ… ØªÙØ¹ÙŠÙ„ ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡ (Ø§Ù†Ù‚Ø± Ù„Ù„Ø¥Ù„ØºØ§Ø¡)" : "Ø§Ù†Ù‚Ø± Ù‡Ù†Ø§ Ù„ØªÙØ¹ÙŠÙ„ ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡";
});

$("startBtn").addEventListener("click", startQuiz);

  $("prevBtn").addEventListener("click", prevQ);
  $("nextBtn").addEventListener("click", nextQ);
  $("finishBtn").addEventListener("click", finishQuiz);
  $("resetQuizBtn").addEventListener("click", resetAttempt);

  $("againBtn").addEventListener("click", ()=>show("screenSetup"));
  $("boardBtn2").addEventListener("click", ()=>openBoard("screenResult"));
  $("backFromBoardBtn").addEventListener("click", backFromBoard);

  $("backFromAdminBtn").addEventListener("click", ()=>show(app.ui.adminReturnScreen || "screenHome"));

// Admin: Enter submits login
document.addEventListener("keydown", (e)=>{
  if(e.key==="Enter"){
    const ae = document.activeElement;
    if(ae && (ae.id==="adminUser" || ae.id==="adminPass")){
      e.preventDefault();
      adminLogin();
    }
  }
});


  $("adminLoginBtn").addEventListener("click", adminLogin);

  $("logoutBtn").addEventListener("click", adminLogout);

  $("exportCsvBtn").addEventListener("click", exportCsv);
  $("exportJsonBtn").addEventListener("click", exportJson);
  $("shareJsonBtn").addEventListener("click", shareJson);
  $("importJsonBtn").addEventListener("click", importJson);

  $("pushUnsyncedBtn").addEventListener("click", ()=>pushUnsyncedToGoogleSheet({silent:false}));
  $("pushAllBtn").addEventListener("click", pushAllToGoogleSheet);

  const clr=$("clearLocalBtn");
  if(clr) clr.addEventListener("click", clearLocalResults);
window.addEventListener("popstate", (e)=>{
  const target =
    (e.state && e.state.screen) ||
    routeToScreen(location.hash) ||
    "screenHome";

  // Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ© history Ø¬Ø¯ÙŠØ¯Ø©
  show(target, { history:false });

  // Ø£Ù…Ø§Ù†: Ø¥Ø°Ø§ Ø±Ø¬Ø¹Ù†Ø§ Ø®Ø§Ø±Ø¬ quiz Ø£ÙˆÙ‚Ù Ø§Ù„Ù…Ø¤Ù‚Øª
  if(target !== "screenQuiz") stopSmartTimer();
});

const first = routeToScreen(location.hash);
show(first, { history:true, replace:true });
}
boot();
</script>

  <!-- Non-blocking confirm modal -->
  <div id="confirmOverlay" class="confirmOverlay" aria-hidden="true">
    <div class="confirmBox" role="dialog" aria-modal="true">
      <h3 class="confirmTitle" id="confirmTitle">ØªØ£ÙƒÙŠØ¯</h3>
      <p class="confirmMsg" id="confirmMsg">â€”</p>
      <div class="confirmActions">
        <button id="confirmOkBtn" class="danger">Ù…ÙˆØ§ÙÙ‚</button>
        <button id="confirmCancelBtn">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

</body>
</html>
